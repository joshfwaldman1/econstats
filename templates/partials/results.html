<!-- Results partial - swapped in by HTMX -->

<!-- Query Echo -->
<div class="flex items-start gap-3 mb-6">
    <div class="flex-shrink-0 w-8 h-8 bg-primary-100 rounded-full flex items-center justify-center">
        <svg class="w-4 h-4 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
        </svg>
    </div>
    <div class="pt-1">
        <p class="text-lg font-medium text-slate-800">{{ query }}</p>
    </div>
</div>

<!-- Summary Card -->
<div class="bg-gradient-to-br from-slate-900 to-slate-800 rounded-2xl p-6 mb-6 shadow-xl">
    <p class="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-3">Summary</p>
    <p class="text-white text-lg leading-relaxed">{{ summary }}</p>
</div>

<!-- Related Questions (inline, prominent) -->
<div class="flex flex-wrap gap-2 mb-8">
    <span class="text-sm text-slate-500 py-2">Related:</span>
    {% for label, q in related %}
    <button
        hx-post="/search"
        hx-vals='{"query": "{{ q }}"}'
        hx-target="#results"
        hx-swap="innerHTML"
        hx-indicator="#search-box"
        class="px-4 py-2 bg-white border border-slate-200 rounded-full text-sm font-medium text-slate-600
               hover:border-primary-500 hover:text-primary-600 hover:bg-primary-50
               transition-all duration-200 cursor-pointer"
    >
        {{ label }}
    </button>
    {% endfor %}
</div>

<!-- Metrics Row -->
{% if charts %}
<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
    {% for chart in charts %}
    <div class="bg-white rounded-xl border border-slate-200 p-4 shadow-sm">
        <p class="text-xs font-medium text-slate-500 uppercase tracking-wide mb-1 truncate">
            {{ chart.name[:25] }}{% if chart.name|length > 25 %}...{% endif %}
        </p>
        <p class="text-2xl font-bold text-slate-900">
            {% if 'Percent' in chart.unit or '%' in chart.unit %}
                {{ "%.1f"|format(chart.latest) }}%
            {% elif chart.latest > 1000000 %}
                {{ "%.1f"|format(chart.latest / 1000000) }}M
            {% elif chart.latest > 1000 %}
                {{ "%.0f"|format(chart.latest / 1000) }}K
            {% else %}
                {{ "%.1f"|format(chart.latest) }}
            {% endif %}
        </p>
        {% if chart.yoy_change is not none %}
        <p class="text-sm mt-1 {% if chart.yoy_change >= 0 %}text-emerald-600{% else %}text-red-600{% endif %}">
            {{ "%+.1f"|format(chart.yoy_change) }}% YoY
        </p>
        {% endif %}
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- Charts -->
{% for chart in charts %}
<div class="bg-white rounded-2xl border border-slate-200 shadow-sm mb-6 overflow-hidden">
    <!-- Chart Header -->
    <div class="px-6 py-4 border-b border-slate-100">
        <div class="flex items-center justify-between">
            <div>
                <h3 class="font-semibold text-slate-900">{{ chart.name }}</h3>
                <p class="text-sm text-slate-500">{{ chart.unit }}</p>
            </div>
            <div class="text-right">
                <p class="text-xl font-bold text-slate-900">
                    {% if 'Percent' in chart.unit or '%' in chart.unit %}
                        {{ "%.2f"|format(chart.latest) }}%
                    {% elif chart.latest > 1000000 %}
                        {{ "%.2f"|format(chart.latest / 1000000) }}M
                    {% else %}
                        {{ "%.2f"|format(chart.latest) }}
                    {% endif %}
                </p>
                <p class="text-xs text-slate-400">as of {{ chart.latest_date }}</p>
            </div>
        </div>
    </div>

    <!-- Chart Container -->
    <div id="chart-{{ chart.series_id }}" class="chart-container px-4 py-2"></div>

    <!-- Source -->
    <div class="px-6 py-3 bg-slate-50 border-t border-slate-100">
        <p class="text-xs text-slate-400">
            {{ chart.name }}{% if chart.sa %}, Seasonally Adjusted{% endif %}, {{ chart.source }} via FRED.
        </p>
    </div>
</div>

<script>
(function() {
    const data = {{ chart | tojson }};

    // Build recession shapes
    const shapes = (data.recessions || []).map(r => ({
        type: 'rect',
        xref: 'x',
        yref: 'paper',
        x0: r.start,
        x1: r.end,
        y0: 0,
        y1: 1,
        fillcolor: 'rgba(148, 163, 184, 0.2)',
        line: { width: 0 },
        layer: 'below',
    }));

    Plotly.newPlot('chart-{{ chart.series_id }}', [{
        x: data.dates,
        y: data.values,
        type: 'scatter',
        mode: 'lines',
        fill: 'tozeroy',
        fillcolor: 'rgba(59, 130, 246, 0.08)',
        line: {
            color: '#3b82f6',
            width: 2.5,
        },
        hovertemplate: '<b>%{x|%b %Y}</b><br>%{y:,.2f}<extra></extra>',
    }], {
        margin: { l: 50, r: 20, t: 10, b: 40 },
        height: 280,
        shapes: shapes,
        xaxis: {
            showgrid: false,
            tickformat: '%Y',
            tickfont: { size: 11, color: '#64748b' },
        },
        yaxis: {
            showgrid: true,
            gridcolor: '#f1f5f9',
            tickfont: { size: 11, color: '#64748b' },
            zeroline: false,
        },
        hoverlabel: {
            bgcolor: '#0f172a',
            font: { color: 'white', size: 13 },
            bordercolor: '#0f172a',
        },
        paper_bgcolor: 'transparent',
        plot_bgcolor: 'transparent',
    }, {
        displayModeBar: false,
        responsive: true,
    });
})();
</script>
{% endfor %}

<!-- New Search Link -->
<div class="text-center mt-8">
    <a href="/"
       class="inline-flex items-center gap-2 text-sm text-slate-500 hover:text-primary-600 transition-colors">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
        </svg>
        New search
    </a>
</div>
