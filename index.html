<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EconStats</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: Georgia, 'Times New Roman', serif;
            background: #fafafa;
            color: #1a1a1a;
            line-height: 1.7;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 40px 20px;
        }
        header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        h1 { font-size: 2.2rem; font-weight: normal; margin-bottom: 8px; }
        .subtitle { color: #666; font-size: 1rem; }
        .search-box { display: flex; gap: 10px; margin-bottom: 30px; }
        #query-input {
            flex: 1;
            padding: 14px 18px;
            font-size: 1.1rem;
            font-family: inherit;
            border: 2px solid #ddd;
            border-radius: 4px;
            outline: none;
        }
        #query-input:focus { border-color: #0066cc; }
        button {
            padding: 14px 28px;
            font-size: 1rem;
            font-family: inherit;
            background: #0066cc;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover { background: #0055aa; }
        .controls {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            align-items: center;
        }
        .controls label { color: #666; margin-right: 8px; }
        select {
            padding: 8px 12px;
            font-size: 1rem;
            font-family: inherit;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .quick-links { display: flex; gap: 10px; flex-wrap: wrap; }
        .quick-link {
            padding: 6px 14px;
            font-size: 0.9rem;
            background: #f0f0f0;
            border: 1px solid #ddd;
            color: #333;
            border-radius: 20px;
            cursor: pointer;
        }
        .quick-link:hover { background: #e0e0e0; }
        #results { margin-top: 30px; }
        .narrative {
            background: #fff;
            border: 1px solid #e0e0e0;
            padding: 25px 30px;
            margin-bottom: 30px;
            border-radius: 4px;
        }
        .narrative h2 {
            font-size: 1.4rem;
            font-weight: normal;
            margin-bottom: 15px;
            color: #1a1a1a;
        }
        .narrative p {
            color: #333;
            margin-bottom: 12px;
            font-size: 1.05rem;
        }
        .narrative .highlight { font-weight: bold; }
        .narrative .up { color: #228b22; }
        .narrative .down { color: #cc0000; }
        .chart-section {
            background: #fff;
            border: 1px solid #e0e0e0;
            margin-bottom: 30px;
            border-radius: 4px;
            overflow: hidden;
        }
        .chart-header {
            padding: 15px 20px;
            border-bottom: 1px solid #e0e0e0;
        }
        .chart-title {
            font-size: 1.1rem;
            color: #333;
            margin-bottom: 10px;
        }
        .chart-bullets {
            list-style: disc;
            margin-left: 20px;
            font-size: 0.95rem;
            color: #555;
        }
        .chart-bullets li {
            margin-bottom: 4px;
        }
        .chart-container { padding: 10px; }
        .chart { width: 100%; height: 320px; }
        .chart-actions {
            padding: 10px 20px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        .download-btn {
            padding: 6px 12px;
            font-size: 0.85rem;
            background: #f5f5f5;
            border: 1px solid #ddd;
            color: #333;
            border-radius: 4px;
            cursor: pointer;
        }
        .download-btn:hover { background: #eee; }
        .source-line {
            padding: 12px 20px;
            border-top: 1px solid #e0e0e0;
            font-size: 0.85rem;
            color: #666;
            background: #fafafa;
        }
        .loading { text-align: center; padding: 60px; color: #888; }
        .error {
            background: #fff5f5;
            border: 1px solid #ffcccc;
            color: #cc0000;
            padding: 15px 20px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>EconStats</h1>
            <p class="subtitle">U.S. Economic Data with Context</p>
        </header>

        <div class="search-box">
            <input type="text" id="query-input" placeholder="Search any economic data: jobs, oil prices, China trade, auto sales..." />
            <button onclick="handleSearch()">Search</button>
        </div>

        <div class="controls">
            <div>
                <label>Timeframe:</label>
                <select id="timeframe" onchange="refresh()">
                    <option value="5">5 Years</option>
                    <option value="10">10 Years</option>
                    <option value="20">20 Years</option>
                    <option value="max" selected>All Available</option>
                </select>
            </div>
            <div class="quick-links">
                <span class="quick-link" onclick="search('job market')">Jobs</span>
                <span class="quick-link" onclick="search('inflation')">Inflation</span>
                <span class="quick-link" onclick="search('GDP growth')">GDP</span>
                <span class="quick-link" onclick="search('interest rates')">Rates</span>
                <span class="quick-link" onclick="search('housing')">Housing</span>
                <span class="quick-link" onclick="search('women labor market')">Women</span>
                <span class="quick-link" onclick="search('oil prices')">Oil</span>
                <span class="quick-link" onclick="search('china trade')">China</span>
            </div>
        </div>

        <div id="error"></div>
        <div id="results"></div>
    </div>

    <script>
        const BASE_URL = '/api';

        // Recession periods (NBER official dates)
        const RECESSIONS = [
            { start: '1929-08-01', end: '1933-03-01' },
            { start: '1937-05-01', end: '1938-06-01' },
            { start: '1945-02-01', end: '1945-10-01' },
            { start: '1948-11-01', end: '1949-10-01' },
            { start: '1953-07-01', end: '1954-05-01' },
            { start: '1957-08-01', end: '1958-04-01' },
            { start: '1960-04-01', end: '1961-02-01' },
            { start: '1969-12-01', end: '1970-11-01' },
            { start: '1973-11-01', end: '1975-03-01' },
            { start: '1980-01-01', end: '1980-07-01' },
            { start: '1981-07-01', end: '1982-11-01' },
            { start: '1990-07-01', end: '1991-03-01' },
            { start: '2001-03-01', end: '2001-11-01' },
            { start: '2007-12-01', end: '2009-06-01' },
            { start: '2020-02-01', end: '2020-04-01' },
        ];

        // Series database with significance bullets
        const SERIES_DB = {
            'PAYEMS': {
                name: 'Total Nonfarm Payrolls',
                unit: 'Thousands of Persons',
                source: 'U.S. Bureau of Labor Statistics',
                sa: true,
                bullets: [
                    'The single most important monthly economic indicator. When this number is released on the first Friday of each month, markets move. Rising payrolls signal economic expansion; falling payrolls often precede or confirm recessions.',
                    'Counts every person on a U.S. business payroll (excluding farms). A gain of 150,000+ jobs/month is typically needed just to keep pace with population growth. Gains above 200,000 suggest strong hiring; losses signal trouble.'
                ]
            },
            'CES0500000003': {
                name: 'Average Hourly Earnings (Private)',
                unit: 'Dollars per Hour',
                source: 'U.S. Bureau of Labor Statistics',
                sa: true,
                bullets: [
                    'Shows what American workers actually earn per hour. When wages grow faster than inflation, workers gain purchasing power. When inflation outpaces wages, living standards erode even if paychecks look bigger.',
                    'The Federal Reserve watches wage growth closely: too-fast wage increases can fuel inflation (the "wage-price spiral"), but stagnant wages hurt consumer spending. Healthy growth is roughly 3-4% annually.'
                ],
                canInflationAdjust: true
            },
            'MANEMP': {
                name: 'Manufacturing Employment',
                unit: 'Thousands of Persons',
                source: 'U.S. Bureau of Labor Statistics',
                sa: true,
                bullets: [
                    'Tells the story of American industrial decline and transformation. Manufacturing employed nearly 20 million Americans in 1979; today it\'s around 13 million. This reflects automation, globalization, and the shift to a service economy.',
                    'Still matters economically: manufacturing jobs typically pay above-average wages with benefits. Regional manufacturing losses have devastated communities in the Rust Belt and reshaped American politics.'
                ]
            },
            'UNRATE': {
                name: 'Unemployment Rate',
                unit: 'Percent',
                source: 'U.S. Bureau of Labor Statistics',
                sa: true,
                bullets: [
                    'The percentage of Americans who want jobs but can\'t find them. Below 4% is historically considered "full employment" where nearly everyone who wants work has it. Above 6% signals significant economic distress; 10%+ indicates crisis.',
                    'Important limitation: only counts people actively looking for work. Doesn\'t include "discouraged workers" who\'ve given up searching or people forced into part-time work. The "real" unemployment rate (U-6) is typically 3-4 percentage points higher.'
                ]
            },
            'CIVPART': {
                name: 'Labor Force Participation Rate',
                unit: 'Percent',
                source: 'U.S. Bureau of Labor Statistics',
                sa: true,
                bullets: [
                    'Shows what share of working-age Americans are either employed or actively job-hunting. Peaked at 67% in 2000 and has declined to around 62%. This decline means millions of potential workers are sitting on the sidelines.',
                    'The decline reflects multiple forces: Baby Boomers retiring, more young people in college, disability rolls expanding, and some prime-age workers (especially men) dropping out. Low participation constrains economic growth potential.'
                ]
            },
            'LNS12300060': {
                name: 'Prime-Age Employment-Population Ratio (25-54)',
                unit: 'Percent',
                source: 'U.S. Bureau of Labor Statistics',
                sa: true,
                bullets: [
                    'Many economists consider this the single best measure of labor market health. It shows what percentage of Americans aged 25-54 (too old for school, too young for retirement) actually have jobs. Higher is better.',
                    'Avoids the distortions in unemployment rate and participation rate from retirees and students. Pre-pandemic peak was 80.4% in 2000. Full recovery means getting back to or above that level.'
                ]
            },
            'CPIAUCSL': {
                name: 'Consumer Price Index (All Items)',
                unit: 'Index 1982-84=100',
                source: 'U.S. Bureau of Labor Statistics',
                sa: true,
                showYoY: true,
                yoyUnit: 'Percent Change (Year-over-Year)',
                yoyName: 'CPI Inflation Rate',
                bullets: [
                    'The inflation number you hear on the news. Measures how much more expensive a "basket" of goods and services has become compared to a year ago. At 2%, prices double every 35 years. At 7%, they double in just 10 years.',
                    'Directly affects your wallet: Social Security payments, tax brackets, and TIPS bonds all adjust based on CPI. When CPI runs hot (above 3%), the Fed typically raises interest rates to cool it down, which affects mortgages, car loans, and stock prices.'
                ]
            },
            'CPILFESL': {
                name: 'Core CPI (Less Food & Energy)',
                unit: 'Index 1982-84=100',
                source: 'U.S. Bureau of Labor Statistics',
                sa: true,
                showYoY: true,
                yoyUnit: 'Percent Change (Year-over-Year)',
                yoyName: 'Core CPI Inflation Rate',
                bullets: [
                    'Strips out food and gas prices to reveal the underlying inflation trend. Why? Because gas prices swing wildly with oil markets and food prices bounce with weather and harvests—these "noise" components can mask what\'s really happening.',
                    'Economists and the Fed focus heavily on core inflation because it\'s "stickier" and harder to reverse. If core inflation is high, it usually means inflation has become embedded in the economy through wages, rents, and services—and won\'t come down quickly.'
                ]
            },
            'CUSR0000SEHA': {
                name: 'CPI: Rent of Primary Residence',
                unit: 'Index 1982-84=100',
                source: 'U.S. Bureau of Labor Statistics',
                sa: true,
                showYoY: true,
                yoyUnit: 'Percent Change (Year-over-Year)',
                yoyName: 'Rent Inflation Rate',
                bullets: [
                    'Housing costs are the single largest expense for most Americans, and rent is about 1/3 of the entire CPI calculation. When rents surge (as they did 2021-2023), it pushes overall inflation higher and squeezes household budgets directly.',
                    'Critical quirk: this measure lags actual market rents by 12+ months because it tracks existing leases, not new listings. So when Zillow shows rents falling, CPI rent keeps rising for another year—confusing but important for understanding inflation forecasts.'
                ]
            },
            'PCEPI': {
                name: 'PCE Price Index',
                unit: 'Index 2017=100',
                source: 'U.S. Bureau of Economic Analysis',
                sa: true,
                showYoY: true,
                yoyUnit: 'Percent Change (Year-over-Year)',
                yoyName: 'PCE Inflation Rate',
                bullets: [
                    'The Federal Reserve\'s official preferred inflation measure—when the Fed says it\'s targeting "2% inflation," this is what they mean. PCE typically runs 0.3-0.5 percentage points below CPI because it accounts for consumers switching to cheaper alternatives when prices rise.',
                    'Covers a broader range of spending than CPI, including healthcare paid by employers and government. When you hear Fed officials discuss inflation at press conferences, they\'re almost always talking about PCE, not CPI.'
                ]
            },
            'PCEPILFE': {
                name: 'Core PCE Price Index',
                unit: 'Index 2017=100',
                source: 'U.S. Bureau of Economic Analysis',
                sa: true,
                showYoY: true,
                yoyUnit: 'Percent Change (Year-over-Year)',
                yoyName: 'Core PCE Inflation Rate',
                bullets: [
                    'This is THE number the Fed watches most closely. When Fed Chair Powell discusses whether to raise or cut rates, Core PCE is the key metric. The explicit target is 2.0% year-over-year—above that, expect rate hikes; below, expect cuts or holds.',
                    'Excludes volatile food and energy to show "underlying" inflation. During 2022-2023, Core PCE running at 4-5% (double the target) drove the most aggressive Fed rate hikes in 40 years, pushing mortgage rates from 3% to 7%.'
                ]
            },
            'GDPC1': {
                name: 'Real Gross Domestic Product',
                unit: 'Billions of Chained 2017 Dollars',
                source: 'U.S. Bureau of Economic Analysis',
                sa: true,
                bullets: [
                    'The total value of everything America produces—every haircut, iPhone, surgery, and Ford truck. "Real" means adjusted for inflation, so you\'re seeing actual economic growth, not just price increases. The U.S. economy is roughly $28 trillion annually.',
                    'GDP is the ultimate scorecard: rising GDP means more jobs, higher incomes, and growing prosperity. Two consecutive quarters of negative GDP growth is the informal definition of recession (though the official call comes from NBER economists).'
                ]
            },
            'A191RL1Q225SBEA': {
                name: 'Real GDP Growth Rate',
                unit: 'Percent Change (Quarterly, Annualized)',
                source: 'U.S. Bureau of Economic Analysis',
                sa: true,
                bullets: [
                    'How fast the economy is growing or shrinking. Healthy U.S. growth is typically 2-3% annually. Above 3% is a boom; below 0% means contraction. The "annualized" rate shows what would happen if that quarter\'s pace continued for a full year.',
                    'Released quarterly about a month after each quarter ends, then revised twice. Markets react strongly to surprises. Growth is driven by consumer spending (~70%), business investment, government spending, and net exports.'
                ]
            },
            'FEDFUNDS': {
                name: 'Federal Funds Effective Rate',
                unit: 'Percent',
                source: 'Board of Governors of the Federal Reserve System',
                sa: false,
                bullets: [
                    'The most powerful lever in the global economy. This is the interest rate the Federal Reserve controls directly, and it ripples through every other rate—mortgages, car loans, credit cards, business loans, and savings accounts all move with it.',
                    'When inflation is too high, the Fed raises this rate to make borrowing expensive and slow the economy. When recession threatens, they cut it to stimulate borrowing and spending. Near 0% signals emergency stimulus; 5%+ signals inflation-fighting mode.'
                ]
            },
            'DGS10': {
                name: '10-Year Treasury Yield',
                unit: 'Percent',
                source: 'Board of Governors of the Federal Reserve System',
                sa: false,
                bullets: [
                    'The benchmark interest rate for the entire economy. Mortgage rates, corporate bonds, and international borrowing costs all key off the 10-year Treasury. It reflects what investors expect for growth and inflation over the next decade.',
                    'Unlike short-term rates that the Fed controls directly, the 10-year is set by market forces. When it rises sharply (as in 2022-2023), it can crash bond portfolios, spike mortgage rates, and pressure stock valuations. A key number to watch.'
                ]
            },
            'DGS2': {
                name: '2-Year Treasury Yield',
                unit: 'Percent',
                source: 'Board of Governors of the Federal Reserve System',
                sa: false,
                bullets: [
                    'The market\'s best guess about where the Fed will set interest rates over the next two years. When this rate moves, it\'s often because traders are changing their expectations for Fed policy based on economic data or Fed speeches.',
                    'Closely watched alongside the 10-year yield. The relationship between them (the "yield curve") is one of the most reliable recession predictors in economics. When the 2-year exceeds the 10-year, trouble usually follows.'
                ]
            },
            'T10Y2Y': {
                name: '10-Year Treasury Minus 2-Year (Yield Curve)',
                unit: 'Percent',
                source: 'Board of Governors of the Federal Reserve System',
                sa: false,
                bullets: [
                    'One of the most reliable recession warning signals in economics. Normally positive (long-term rates exceed short-term). When it goes negative ("inverts"), it has preceded every U.S. recession since 1970, typically by 12-18 months.',
                    'Why does it work? An inverted curve means investors expect the Fed will need to cut rates in the future due to economic weakness. It\'s not a guarantee of recession, but when this flashes red, economists pay attention. Inverted 2022-2024.'
                ]
            },
            'MORTGAGE30US': {
                name: '30-Year Fixed Mortgage Rate',
                unit: 'Percent',
                source: 'Freddie Mac',
                sa: false,
                bullets: [
                    'The rate that determines whether Americans can afford to buy homes. At 3% (2020-2021), a $400K house costs $1,686/month. At 7% (2023), the same house costs $2,661/month—a 58% increase in monthly payment with no change in home price.',
                    'Roughly equals the 10-year Treasury yield plus a 1.5-2.5% spread for risk. The 2022-2023 spike from 3% to 7%+ was the fastest increase in 40 years, freezing the housing market as sellers refused to give up low-rate mortgages.'
                ]
            },
            'CSUSHPINSA': {
                name: 'S&P/Case-Shiller National Home Price Index',
                unit: 'Index Jan 2000=100',
                source: 'S&P Dow Jones Indices LLC',
                sa: false,
                bullets: [
                    'The gold standard for tracking U.S. home prices. Uses "repeat sales" methodology—tracking the same homes over time—to measure true price appreciation, not just changes in what types of homes are selling. Index of 300 means prices have tripled since 2000.',
                    'Home equity is the largest source of wealth for most American families. This index captures booms (2004-2006, 2020-2022) and busts (2007-2012). Lags real-time market by 2-3 months. Regional indices available for 20 major metro areas.'
                ]
            },
            'HOUST': {
                name: 'Housing Starts',
                unit: 'Thousands of Units (Annual Rate)',
                source: 'U.S. Census Bureau',
                sa: true,
                bullets: [
                    'Counts new residential construction projects breaking ground each month. A leading indicator because builders only start homes when they\'re confident about demand. Typical healthy range is 1.2-1.6 million annually; below 1 million signals housing recession.',
                    'Chronically low housing starts since 2008 have contributed to today\'s housing shortage. The U.S. is estimated to be 3-5 million homes short of demand. Rising starts help affordability eventually, but takes 6-12 months for new homes to hit the market.'
                ]
            },
            'UMCSENT': {
                name: 'University of Michigan Consumer Sentiment',
                unit: 'Index 1966:Q1=100',
                source: 'University of Michigan',
                sa: false,
                bullets: [
                    'Measures how optimistic or pessimistic American consumers feel about the economy, based on monthly surveys. Since consumer spending is ~70% of GDP, how people feel often predicts how they\'ll spend. Index around 100 is neutral; below 70 is deeply pessimistic.',
                    'Collapsed to historic lows in 2022 despite low unemployment, largely due to inflation eroding purchasing power. Useful for gauging "vibes" that might not show up in hard data yet. Released twice monthly (preliminary and final).'
                ]
            },
            'RSXFS': {
                name: 'Retail Sales (ex. Food Services)',
                unit: 'Millions of Dollars',
                source: 'U.S. Census Bureau',
                sa: true,
                bullets: [
                    'The monthly pulse of American consumer spending at stores and online. Excludes restaurants to focus on goods purchases. Strong retail sales signal confident consumers with money to spend; weak sales often precede or confirm economic slowdowns.',
                    'Highly volatile month-to-month due to weather, holidays, and stimulus checks. The 2020-2021 stimulus drove unprecedented spikes. Watch the 3-month trend rather than single months. Inflation-adjusted view shows real purchasing volume.'
                ],
                canInflationAdjust: true
            },
            'INDPRO': {
                name: 'Industrial Production Index',
                unit: 'Index 2017=100',
                source: 'Board of Governors of the Federal Reserve System',
                sa: true,
                bullets: [
                    'Measures physical output from American factories, mines, and utilities. Unlike GDP which can be skewed by financial services, this shows actual stuff being made. A direct measure of industrial health and capacity utilization.',
                    'Often peaks before recessions and troughs before recoveries, making it a leading indicator. The Fed produces this data, giving it credibility. Breakdown by industry (auto, tech, energy) helps identify sector-specific trends.'
                ]
            },
            'IPMAN': {
                name: 'Industrial Production: Manufacturing',
                unit: 'Index 2017=100',
                source: 'Board of Governors of the Federal Reserve System',
                sa: true,
                bullets: [
                    'Factory output specifically, excluding mining and utilities. Shows whether American manufacturers are ramping up or slowing down. Important for understanding industrial competitiveness and the health of the goods-producing sector.',
                    'Manufacturing is only ~11% of GDP but has outsized importance for middle-class jobs, exports, and supply chains. This index captured the 2020 COVID collapse and subsequent recovery, as well as ongoing reshoring trends.'
                ]
            },
            'SP500': {
                name: 'S&P 500 Index',
                unit: 'Index',
                source: 'S&P Dow Jones Indices LLC',
                sa: false,
                bullets: [
                    'The closest thing to a single number for "the stock market." Includes 500 of America\'s largest companies (Apple, Microsoft, Amazon, etc.) weighted by market value. When news says "stocks rose 2% today," they usually mean this index.',
                    'Represents roughly $40 trillion in wealth and 80% of U.S. stock market value. Most 401(k)s and index funds track it. Long-term average return is ~10% annually (7% after inflation). Bear markets (20%+ drops) occur roughly once per decade.'
                ]
            },
            'M2SL': {
                name: 'M2 Money Supply',
                unit: 'Billions of Dollars',
                source: 'Board of Governors of the Federal Reserve System',
                sa: true,
                bullets: [
                    'Total money sloshing around the economy: cash, checking accounts, savings accounts, and money market funds. When M2 grows rapidly, there\'s more money chasing goods, which can fuel inflation. When it shrinks, spending power contracts.',
                    'Exploded 40% during COVID stimulus (2020-2021), the fastest growth ever recorded. Many economists believe this helped cause the 2022-2023 inflation surge. Now contracting for the first time since the 1930s—a historically rare event worth watching.'
                ]
            },
            'BOPGSTB': {
                name: 'Trade Balance (Goods & Services)',
                unit: 'Millions of Dollars',
                source: 'U.S. Bureau of Economic Analysis',
                sa: true,
                bullets: [
                    'Exports minus imports. The U.S. has run a trade deficit (negative balance) since the 1970s, currently around $800 billion annually. This means America buys more from the world than it sells—we import cars, electronics, and oil; we export services, agriculture, and aircraft.',
                    'Trade deficits aren\'t inherently bad—they partly reflect strong U.S. consumer demand and the dollar\'s role as global reserve currency. But persistent deficits in specific sectors (like manufacturing) have political implications and affect jobs in trade-exposed industries.'
                ]
            },
            'PSAVERT': {
                name: 'Personal Saving Rate',
                unit: 'Percent',
                source: 'U.S. Bureau of Economic Analysis',
                sa: true,
                bullets: [
                    'What percentage of after-tax income Americans save rather than spend. Historically averaged 7-8%. Spiked to 33% during COVID lockdowns (nowhere to spend + stimulus checks). Now around 4-5%, below historical norms.',
                    'Low savings can signal either consumer confidence (willing to spend) or financial stress (forced to spend). Combined with high credit card debt, today\'s low savings rate concerns some economists about household financial resilience if recession hits.'
                ]
            },
            'JTSJOL': {
                name: 'Job Openings (JOLTS)',
                unit: 'Thousands',
                source: 'U.S. Bureau of Labor Statistics',
                sa: true,
                bullets: [
                    'Counts unfilled job positions across the economy. When openings vastly exceed unemployed workers (as in 2021-2022 with 2 openings per job seeker), employers struggle to hire and wages rise. When openings fall below unemployed (as in recessions), workers struggle.',
                    'The ratio of job openings to unemployed workers is a key measure of labor market "tightness" that the Fed watches closely. Very tight labor markets can fuel wage-driven inflation. The JOLTS report also includes quits, hires, and layoffs data.'
                ]
            },
            // Women's labor market
            'LNS14000002': {
                name: 'Unemployment Rate - Women',
                unit: 'Percent',
                source: 'U.S. Bureau of Labor Statistics',
                sa: true,
                bullets: [
                    'Unemployment rate for women aged 16+. Historically tracked closely with men\'s rate but diverges during certain recessions. The 2020 COVID recession hit women harder initially ("she-cession") due to job losses in service sectors and childcare burdens.',
                    'Women\'s unemployment fell below men\'s in 2022 for the first time in decades, reflecting strong demand in healthcare, education, and service jobs where women are concentrated.'
                ]
            },
            'LNS11300002': {
                name: 'Labor Force Participation Rate - Women',
                unit: 'Percent',
                source: 'U.S. Bureau of Labor Statistics',
                sa: true,
                bullets: [
                    'Share of women aged 16+ who are working or actively seeking work. Rose dramatically from 34% in 1950 to peak at 60% in 2000—one of the most significant economic shifts in American history. Has since plateaued around 57%.',
                    'The U.S. lags other developed countries in women\'s participation, partly due to lack of paid family leave and affordable childcare. Economists estimate that matching Canada\'s rate could add millions of workers and boost GDP significantly.'
                ]
            },
            'LNS12300062': {
                name: 'Prime-Age Employment-Population Ratio - Women (25-54)',
                unit: 'Percent',
                source: 'U.S. Bureau of Labor Statistics',
                sa: true,
                bullets: [
                    'The share of women aged 25-54 who are employed—the best measure of women\'s labor market success, filtering out students and retirees. Hit all-time high of 75.3% in 2024, finally surpassing the pre-2000 peak.',
                    'Shows the long-term trend of women\'s workforce integration. The COVID recovery saw prime-age women return to work faster than previous recessions, possibly due to remote work flexibility and strong demand in female-dominated sectors.'
                ]
            },
            // Men's labor market
            'LNS14000001': {
                name: 'Unemployment Rate - Men',
                unit: 'Percent',
                source: 'U.S. Bureau of Labor Statistics',
                sa: true,
                bullets: [
                    'Unemployment rate for men aged 16+. Men\'s unemployment typically spikes more in recessions due to concentration in cyclical industries like construction and manufacturing. The 2008-2009 recession was dubbed a "man-cession" for this reason.',
                    'Long-term trend shows men\'s labor market position weakening relative to women, especially for those without college degrees. Manufacturing decline has disproportionately affected male workers.'
                ]
            },
            'LNS12300061': {
                name: 'Prime-Age Employment-Population Ratio - Men (25-54)',
                unit: 'Percent',
                source: 'U.S. Bureau of Labor Statistics',
                sa: true,
                bullets: [
                    'Share of men aged 25-54 who are employed. Has declined from 94% in 1960 to around 86% today—a troubling long-term trend that economists call "the decline of working-age men." Not fully explained by any single factor.',
                    'Possible causes include disability, incarceration effects, opioid crisis, video games, and mismatch between available jobs and skills. This decline represents millions of prime-age men not contributing to the economy.'
                ]
            },
            // Sector employment
            'USCONS': {
                name: 'Construction Employment',
                unit: 'Thousands of Persons',
                source: 'U.S. Bureau of Labor Statistics',
                sa: true,
                bullets: [
                    'Jobs in residential and commercial construction. Highly cyclical—one of the first sectors to crash in recessions and recover in expansions. The 2008 housing bust wiped out 2.3 million construction jobs (30% of the sector).',
                    'A predominantly male workforce (97%). Construction employment signals housing market health and infrastructure investment. Current levels suggest neither boom nor bust conditions.'
                ]
            },
            'USFIRE': {
                name: 'Financial Activities Employment',
                unit: 'Thousands of Persons',
                source: 'U.S. Bureau of Labor Statistics',
                sa: true,
                bullets: [
                    'Jobs in finance, insurance, and real estate (FIRE). Includes banks, investment firms, insurers, and real estate agencies. Relatively stable employment but affected by interest rate cycles and financial crises.',
                    'High-paying sector concentrated in major cities (NYC, Charlotte, SF). The 2008 crisis caused significant layoffs; more recent fintech disruption is reshaping the industry.'
                ]
            },
            'USEHS': {
                name: 'Education and Health Services Employment',
                unit: 'Thousands of Persons',
                source: 'U.S. Bureau of Labor Statistics',
                sa: true,
                bullets: [
                    'Jobs in schools, colleges, hospitals, clinics, and social services. The largest and most recession-resistant employment sector—even grew during 2008-2009. Now employs over 25 million Americans.',
                    'Predominantly female workforce (about 75%). Driven by aging population, healthcare expansion, and education demand. Chronic labor shortages in nursing and teaching persist despite strong job growth.'
                ]
            },
            'USLAH': {
                name: 'Leisure and Hospitality Employment',
                unit: 'Thousands of Persons',
                source: 'U.S. Bureau of Labor Statistics',
                sa: true,
                bullets: [
                    'Jobs in restaurants, hotels, entertainment, and recreation. The hardest-hit sector during COVID—lost 8.2 million jobs (49%) in two months. Recovery took until 2023 to fully restore pre-pandemic levels.',
                    'Lower-wage sector with high turnover; employs many young and part-time workers. Serves as a bellwether for consumer discretionary spending and economic confidence.'
                ]
            },
            'USPBS': {
                name: 'Professional and Business Services Employment',
                unit: 'Thousands of Persons',
                source: 'U.S. Bureau of Labor Statistics',
                sa: true,
                bullets: [
                    'Jobs in law, accounting, consulting, engineering, tech services, and administrative support. One of the fastest-growing sectors; includes many high-paying professional jobs and also temp workers.',
                    'Sensitive to business investment cycles—companies hire consultants and contractors when confident about growth. Includes the temp employment subcategory, which is a leading indicator (temps get cut first in downturns).'
                ]
            },
            'CES4300000001': {
                name: 'Transportation and Warehousing Employment',
                unit: 'Thousands of Persons',
                source: 'U.S. Bureau of Labor Statistics',
                sa: true,
                bullets: [
                    'Jobs in trucking, rail, air transport, warehousing, and delivery services. Surged during the e-commerce boom and COVID shift to online shopping—Amazon alone added hundreds of thousands of warehouse jobs.',
                    'A barometer of goods movement in the economy. Driver shortages have been a persistent issue. Automation and autonomous vehicles pose long-term disruption risks to this predominantly male sector.'
                ]
            },
            'USINFO': {
                name: 'Information Sector Employment',
                unit: 'Thousands of Persons',
                source: 'U.S. Bureau of Labor Statistics',
                sa: true,
                bullets: [
                    'Jobs in publishing, telecom, broadcasting, and software/tech. Despite the importance of "tech," this sector is relatively small (~3 million jobs) because tech companies are surprisingly lean on headcount.',
                    'Experienced massive layoffs in 2022-2023 after pandemic over-hiring. The tech layoffs made headlines but represent a small share of total U.S. employment. Includes both declining (newspapers) and growing (software) subsectors.'
                ]
            },
            'USGOVT': {
                name: 'Government Employment',
                unit: 'Thousands of Persons',
                source: 'U.S. Bureau of Labor Statistics',
                sa: true,
                bullets: [
                    'Federal, state, and local government jobs excluding military. About 23 million total, mostly at state/local level (teachers, police, firefighters). Federal government is only ~3 million civilian employees.',
                    'Counter-cyclical during recessions (doesn\'t lay off like private sector) but often lags in recoveries due to budget constraints. Government pay has fallen behind private sector in many fields, creating recruitment challenges.'
                ]
            },
        };

        // Query mappings with grouping hints
        const QUERY_MAP = {
            // Demographic labor market queries
            'women\'s labor': { series: ['LNS14000002', 'LNS12300062', 'LNS11300002'], combine: false },
            'women labor': { series: ['LNS14000002', 'LNS12300062', 'LNS11300002'], combine: false },
            'female labor': { series: ['LNS14000002', 'LNS12300062', 'LNS11300002'], combine: false },
            'female employment': { series: ['LNS14000002', 'LNS12300062'], combine: false },
            'women employment': { series: ['LNS14000002', 'LNS12300062'], combine: false },
            'women\'s employment': { series: ['LNS14000002', 'LNS12300062'], combine: false },
            'women unemployment': { series: ['LNS14000002'], combine: false },
            'women\'s unemployment': { series: ['LNS14000002'], combine: false },
            'female unemployment': { series: ['LNS14000002'], combine: false },
            'women participation': { series: ['LNS11300002'], combine: false },
            'women\'s participation': { series: ['LNS11300002'], combine: false },
            'female participation': { series: ['LNS11300002'], combine: false },
            'men\'s labor': { series: ['LNS14000001', 'LNS12300061'], combine: false },
            'men labor': { series: ['LNS14000001', 'LNS12300061'], combine: false },
            'male labor': { series: ['LNS14000001', 'LNS12300061'], combine: false },
            'male employment': { series: ['LNS14000001', 'LNS12300061'], combine: false },
            'men employment': { series: ['LNS14000001', 'LNS12300061'], combine: false },
            'men\'s employment': { series: ['LNS14000001', 'LNS12300061'], combine: false },
            'men unemployment': { series: ['LNS14000001'], combine: false },
            'men\'s unemployment': { series: ['LNS14000001'], combine: false },
            'male unemployment': { series: ['LNS14000001'], combine: false },
            'gender employment': { series: ['LNS12300062', 'LNS12300061'], combine: true }, // Compare M vs F

            // Sector employment queries
            'construction jobs': { series: ['USCONS'], combine: false },
            'construction employment': { series: ['USCONS'], combine: false },
            'healthcare jobs': { series: ['USEHS'], combine: false },
            'healthcare employment': { series: ['USEHS'], combine: false },
            'education jobs': { series: ['USEHS'], combine: false },
            'education employment': { series: ['USEHS'], combine: false },
            'restaurant jobs': { series: ['USLAH'], combine: false },
            'hospitality jobs': { series: ['USLAH'], combine: false },
            'hospitality employment': { series: ['USLAH'], combine: false },
            'leisure employment': { series: ['USLAH'], combine: false },
            'tech jobs': { series: ['USINFO'], combine: false },
            'tech employment': { series: ['USINFO'], combine: false },
            'technology jobs': { series: ['USINFO'], combine: false },
            'information sector': { series: ['USINFO'], combine: false },
            'finance jobs': { series: ['USFIRE'], combine: false },
            'financial employment': { series: ['USFIRE'], combine: false },
            'banking jobs': { series: ['USFIRE'], combine: false },
            'government jobs': { series: ['USGOVT'], combine: false },
            'government employment': { series: ['USGOVT'], combine: false },
            'public sector': { series: ['USGOVT'], combine: false },
            'professional services': { series: ['USPBS'], combine: false },
            'business services': { series: ['USPBS'], combine: false },
            'trucking': { series: ['CES4300000001'], combine: false },
            'transportation jobs': { series: ['CES4300000001'], combine: false },
            'warehousing': { series: ['CES4300000001'], combine: false },
            'logistics': { series: ['CES4300000001'], combine: false },

            // General labor market
            'job market': { series: ['PAYEMS', 'UNRATE'], combine: false },
            'jobs': { series: ['PAYEMS', 'UNRATE'], combine: false },
            'employment': { series: ['PAYEMS', 'UNRATE'], combine: false },
            'unemployment': { series: ['UNRATE'], combine: false },
            'labor market': { series: ['PAYEMS', 'UNRATE'], combine: false },
            'labor force': { series: ['CIVPART', 'LNS12300060'], combine: true }, // Same unit (%)
            'prime age': { series: ['LNS12300060'], combine: false },
            'participation': { series: ['CIVPART'], combine: false },
            'wages': { series: ['CES0500000003'], combine: false },
            'earnings': { series: ['CES0500000003'], combine: false },

            // Inflation
            'inflation': { series: ['CPIAUCSL', 'CPILFESL'], combine: true }, // Same unit
            'cpi': { series: ['CPIAUCSL'], combine: false },
            'core inflation': { series: ['CPILFESL'], combine: false },
            'pce': { series: ['PCEPI', 'PCEPILFE'], combine: true },
            'rent': { series: ['CUSR0000SEHA'], combine: false },
            'rent inflation': { series: ['CUSR0000SEHA'], combine: false },

            // GDP
            'gdp': { series: ['GDPC1'], combine: false },
            'gdp growth': { series: ['A191RL1Q225SBEA'], combine: false },
            'economic growth': { series: ['A191RL1Q225SBEA'], combine: false },
            'economy': { series: ['A191RL1Q225SBEA', 'UNRATE'], combine: false },

            // Interest rates
            'interest rates': { series: ['FEDFUNDS', 'DGS10'], combine: true }, // Both %
            'fed funds': { series: ['FEDFUNDS'], combine: false },
            'federal reserve': { series: ['FEDFUNDS'], combine: false },
            'treasury': { series: ['DGS10', 'DGS2'], combine: true },
            'yield curve': { series: ['T10Y2Y'], combine: false },
            'mortgage': { series: ['MORTGAGE30US'], combine: false },
            'mortgage rates': { series: ['MORTGAGE30US'], combine: false },

            // Housing
            'housing': { series: ['CSUSHPINSA', 'HOUST'], combine: false },
            'home prices': { series: ['CSUSHPINSA'], combine: false },
            'house prices': { series: ['CSUSHPINSA'], combine: false },
            'housing starts': { series: ['HOUST'], combine: false },
            'real estate': { series: ['CSUSHPINSA', 'MORTGAGE30US'], combine: false },

            // Consumer
            'consumer sentiment': { series: ['UMCSENT'], combine: false },
            'consumer confidence': { series: ['UMCSENT'], combine: false },
            'consumer spending': { series: ['RSXFS'], combine: false },
            'retail sales': { series: ['RSXFS'], combine: false },
            'retail': { series: ['RSXFS'], combine: false },
            'saving': { series: ['PSAVERT'], combine: false },
            'savings rate': { series: ['PSAVERT'], combine: false },

            // Industrial
            'manufacturing': { series: ['IPMAN', 'MANEMP'], combine: false },
            'industrial production': { series: ['INDPRO'], combine: false },
            'factories': { series: ['IPMAN'], combine: false },

            // Financial markets
            'stock market': { series: ['SP500'], combine: false },
            'stocks': { series: ['SP500'], combine: false },
            's&p': { series: ['SP500'], combine: false },
            's&p 500': { series: ['SP500'], combine: false },
            'money supply': { series: ['M2SL'], combine: false },
            'm2': { series: ['M2SL'], combine: false },

            // Trade
            'trade': { series: ['BOPGSTB'], combine: false },
            'trade deficit': { series: ['BOPGSTB'], combine: false },
            'exports': { series: ['BOPGSTB'], combine: false },
            'imports': { series: ['BOPGSTB'], combine: false },

            // Other
            'job openings': { series: ['JTSJOL'], combine: false },
            'jolts': { series: ['JTSJOL'], combine: false },
        };

        let currentQuery = null;
        let currentSeries = [];
        let currentData = [];
        let cpiData = null;

        // Load CPI for inflation adjustment
        async function loadCPI() {
            try {
                const resp = await fetch(`${BASE_URL}/series/observations?series_id=CPIAUCSL&observation_start=1947-01-01`);
                const data = await resp.json();
                cpiData = {};
                for (const obs of (data.observations || [])) {
                    if (obs.value !== '.') {
                        cpiData[obs.date.substring(0, 7)] = parseFloat(obs.value);
                    }
                }
            } catch (e) {
                console.error('Failed to load CPI:', e);
            }
        }
        loadCPI();

        function normalizeQuery(text) {
            // Normalize for matching: lowercase, remove apostrophes, collapse spaces
            return text.toLowerCase()
                .replace(/[''`]/g, '')  // Remove apostrophes
                .replace(/[^\w\s]/g, ' ')  // Replace other punctuation with space
                .replace(/\s+/g, ' ')  // Collapse multiple spaces
                .trim();
        }

        function tokenize(text) {
            return normalizeQuery(text).split(' ').filter(t => t.length > 0);
        }

        function findSeries(query) {
            const q = normalizeQuery(query);
            const tokens = tokenize(query);

            // Score each query map entry
            const scored = Object.entries(QUERY_MAP).map(([key, config]) => {
                const normalizedKey = normalizeQuery(key);
                const keyTokens = tokenize(key);

                let score = 0;

                // Exact phrase match - highest score
                if (q.includes(normalizedKey)) {
                    score += 100 + normalizedKey.length;
                }

                // Token matching - count how many key tokens appear in query
                for (const kt of keyTokens) {
                    if (tokens.includes(kt)) {
                        score += 10;
                    } else if (tokens.some(t => t.includes(kt) || kt.includes(t))) {
                        score += 5; // Partial match
                    }
                }

                // Bonus for matching all key tokens
                if (keyTokens.every(kt => tokens.some(t => t.includes(kt) || kt.includes(t)))) {
                    score += 20;
                }

                return { key, config, score };
            });

            // Get best match above threshold
            const best = scored.filter(s => s.score > 15).sort((a, b) => b.score - a.score)[0];

            if (best) {
                return {
                    series: best.config.series.map(id => ({ id, ...SERIES_DB[id] })),
                    combine: best.config.combine
                };
            }
            return null;
        }

        async function searchFRED(query, limit = 5) {
            try {
                // Search FRED API - prioritize popular, active series
                const resp = await fetch(`${BASE_URL}/series/search?search_text=${encodeURIComponent(query)}&limit=${limit}&order_by=popularity&sort_order=desc&filter_variable=frequency&filter_value=Monthly`);
                const data = await resp.json();

                if (data.seriess && data.seriess.length > 0) {
                    // Filter to series with recent data and reasonable popularity
                    const validSeries = data.seriess.filter(s => {
                        const lastObs = new Date(s.observation_end);
                        const oneYearAgo = new Date();
                        oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 2);
                        return lastObs > oneYearAgo; // Has data within last 2 years
                    });

                    const seriesToUse = validSeries.length > 0 ? validSeries : data.seriess;

                    return {
                        series: seriesToUse.slice(0, 4).map(s => ({
                            id: s.id,
                            name: s.title,
                            unit: s.units || '',
                            source: s.source || 'Federal Reserve Economic Data',
                            sa: s.seasonal_adjustment_short === 'SA',
                            frequency: s.frequency,
                            fromSearch: true,
                            bullets: [
                                s.notes ? cleanNotes(s.notes) : `FRED series ${s.id}: ${s.title}`,
                                `Source: ${s.source || 'FRED'}. Frequency: ${s.frequency}. ${s.seasonal_adjustment || 'Not seasonally adjusted'}.`
                            ]
                        })),
                        combine: false,
                        isSearchResult: true
                    };
                }

                // If monthly filter returned nothing, try without filter
                const resp2 = await fetch(`${BASE_URL}/series/search?search_text=${encodeURIComponent(query)}&limit=${limit}&order_by=popularity&sort_order=desc`);
                const data2 = await resp2.json();

                if (data2.seriess && data2.seriess.length > 0) {
                    return {
                        series: data2.seriess.slice(0, 4).map(s => ({
                            id: s.id,
                            name: s.title,
                            unit: s.units || '',
                            source: s.source || 'Federal Reserve Economic Data',
                            sa: s.seasonal_adjustment_short === 'SA',
                            frequency: s.frequency,
                            fromSearch: true,
                            bullets: [
                                s.notes ? cleanNotes(s.notes) : `FRED series ${s.id}: ${s.title}`,
                                `Source: ${s.source || 'FRED'}. Frequency: ${s.frequency}. ${s.seasonal_adjustment || 'Not seasonally adjusted'}.`
                            ]
                        })),
                        combine: false,
                        isSearchResult: true
                    };
                }
            } catch (e) {
                console.error('FRED search failed:', e);
            }
            return null;
        }

        function cleanNotes(notes) {
            // Clean up FRED notes - take first sentence or two, remove excessive formatting
            if (!notes) return '';
            let clean = notes
                .replace(/\s+/g, ' ')
                .replace(/\([^)]*\)/g, '') // Remove parentheticals
                .trim();

            // Get first 200 chars ending at a sentence
            if (clean.length > 200) {
                const cutoff = clean.substring(0, 200).lastIndexOf('.');
                if (cutoff > 50) {
                    clean = clean.substring(0, cutoff + 1);
                } else {
                    clean = clean.substring(0, 200) + '...';
                }
            }
            return clean;
        }

        async function fetchData(seriesId, years) {
            const start = years === 'max' ? '1900-01-01' :
                new Date(Date.now() - years * 365.25 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];

            const resp = await fetch(`${BASE_URL}/series/observations?series_id=${seriesId}&observation_start=${start}`);
            const data = await resp.json();
            return (data.observations || []).filter(o => o.value !== '.').map(o => ({
                date: o.date,
                value: parseFloat(o.value)
            }));
        }

        function calculateYoY(data, frequency = 'monthly') {
            const result = [];
            // For monthly data, look back 12 periods; for quarterly, 4 periods
            const lookback = frequency === 'quarterly' ? 4 : 12;
            for (let i = lookback; i < data.length; i++) {
                const current = data[i];
                const yearAgo = data[i - lookback];
                if (current && yearAgo && yearAgo.value !== 0) {
                    const yoy = ((current.value - yearAgo.value) / yearAgo.value) * 100;
                    result.push({ date: current.date, value: yoy });
                }
            }
            return result;
        }

        function adjustForInflation(data, baseYear = 2024) {
            if (!cpiData || Object.keys(cpiData).length === 0) {
                console.warn('CPI data not loaded, cannot adjust for inflation');
                return data;
            }

            // Get the CPI value for the base period (use December of base year or latest available)
            const basePeriods = [`${baseYear}-12`, `${baseYear}-06`, `${baseYear}-01`];
            let baseCPI = null;
            for (const period of basePeriods) {
                if (cpiData[period]) {
                    baseCPI = cpiData[period];
                    break;
                }
            }
            if (!baseCPI) {
                // Use the most recent CPI value as base
                const sortedPeriods = Object.keys(cpiData).sort().reverse();
                baseCPI = cpiData[sortedPeriods[0]];
            }

            return data.map(d => {
                const period = d.date.substring(0, 7);
                const periodCPI = cpiData[period];
                if (periodCPI && periodCPI > 0) {
                    // Convert to real (base year) dollars
                    return { date: d.date, value: d.value * (baseCPI / periodCPI) };
                }
                return d;
            }).filter(d => d.value !== undefined);
        }

        function generateNarrative(seriesList, dataList, isSearchResult = false) {
            const years = document.getElementById('timeframe').value;
            const periodText = years === 'max' ? 'over the available history' : `over the past ${years} years`;

            let html = `<div class="narrative"><h2>Summary</h2>`;

            // Show AI economist explanation if available
            if (aiExplanation) {
                html += `<p style="font-style: italic; color: #444; margin-bottom: 15px; padding: 10px; background: #f8f8f8; border-left: 3px solid #0066cc;">${aiExplanation}</p>`;
            } else if (isSearchResult) {
                html += `<p style="color: #666; font-style: italic; margin-bottom: 15px;">Results from FRED database search.</p>`;
            }

            for (let i = 0; i < seriesList.length; i++) {
                const series = seriesList[i];
                const data = dataList[i];
                if (!data || data.length === 0) continue;

                const latest = data[data.length - 1];
                const first = data[0];
                const change = latest.value - first.value;
                const pctChange = first.value !== 0 ? (change / Math.abs(first.value)) * 100 : 0;

                // Find pre-COVID comparison if applicable
                const preCovid = data.find(d => d.date >= '2020-02-01' && d.date <= '2020-02-29');
                let covidComparison = '';
                if (preCovid) {
                    const vsPreCovid = ((latest.value - preCovid.value) / Math.abs(preCovid.value)) * 100;
                    covidComparison = ` Compared to Feb 2020 (pre-pandemic): <span class="${vsPreCovid >= 0 ? 'up' : 'down'}">${vsPreCovid >= 0 ? '+' : ''}${vsPreCovid.toFixed(1)}%</span>.`;
                }

                html += `<p>`;
                html += `<span class="highlight">${series.name}</span> `;
                html += `is at <strong>${formatNum(latest.value)}</strong> ${series.unit} `;
                html += `(${formatDate(latest.date)}). `;

                const direction = pctChange >= 0 ? 'up' : 'down';
                html += `${periodText.charAt(0).toUpperCase() + periodText.slice(1)}, `;
                html += `<span class="${direction}">${pctChange >= 0 ? '+' : ''}${pctChange.toFixed(1)}%</span>`;
                html += ` from ${formatNum(first.value)}.`;
                html += covidComparison;
                html += `</p>`;
            }

            html += `</div>`;
            return html;
        }

        function formatNum(n) {
            if (n === undefined || n === null || isNaN(n)) return 'N/A';
            if (Math.abs(n) >= 1e12) return (n / 1e12).toFixed(2) + ' trillion';
            if (Math.abs(n) >= 1e9) return (n / 1e9).toFixed(2) + ' billion';
            if (Math.abs(n) >= 1e6) return (n / 1e6).toFixed(2) + ' million';
            if (Math.abs(n) >= 1e3) return n.toLocaleString('en-US', { maximumFractionDigits: 1 });
            if (Math.abs(n) < 10) return n.toFixed(2);
            return n.toFixed(1);
        }

        function formatDate(d) {
            if (!d) return '';
            const [y, m] = d.split('-');
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            return `${months[parseInt(m) - 1]} ${y}`;
        }

        function createChart(container, seriesList, dataList, combine = false) {
            const colors = ['#0066cc', '#cc3300', '#009933', '#9933cc'];
            const traces = [];

            // Find actual data range for x-axis
            let minDate = null, maxDate = null;
            for (const data of dataList) {
                if (data.length > 0) {
                    const firstDate = data[0].date;
                    const lastDate = data[data.length - 1].date;
                    if (!minDate || firstDate < minDate) minDate = firstDate;
                    if (!maxDate || lastDate > maxDate) maxDate = lastDate;
                }
            }

            for (let i = 0; i < seriesList.length; i++) {
                const series = seriesList[i];
                const data = dataList[i];
                if (!data || data.length === 0) continue;

                traces.push({
                    x: data.map(d => d.date),
                    y: data.map(d => d.value),
                    type: 'scatter',
                    mode: 'lines',
                    name: combine ? series.name : undefined,
                    line: { color: colors[i % colors.length], width: 2 },
                    hovertemplate: `<b>${series.name}</b><br>%{x|%b %Y}<br>%{y:,.2f}<extra></extra>`
                });
            }

            // Filter recessions to data range
            const shapes = RECESSIONS
                .filter(r => r.end >= minDate && r.start <= maxDate)
                .map(r => ({
                    type: 'rect',
                    xref: 'x',
                    yref: 'paper',
                    x0: r.start < minDate ? minDate : r.start,
                    x1: r.end > maxDate ? maxDate : r.end,
                    y0: 0,
                    y1: 1,
                    fillcolor: 'rgba(169, 169, 169, 0.25)',
                    line: { width: 0 }
                }));

            const layout = {
                margin: { t: 10, b: 50, l: 65, r: 20 },
                xaxis: {
                    range: [minDate, maxDate],
                    tickformat: '%Y',
                    gridcolor: '#e5e5e5',
                    linecolor: '#ccc',
                    tickfont: { size: 11 }
                },
                yaxis: {
                    title: { text: seriesList[0].unit, font: { size: 10 }, standoff: 10 },
                    gridcolor: '#e5e5e5',
                    linecolor: '#ccc',
                    tickfont: { size: 11 },
                    automargin: true
                },
                shapes: shapes,
                hovermode: 'x unified',
                paper_bgcolor: 'white',
                plot_bgcolor: 'white',
                showlegend: combine && seriesList.length > 1,
                legend: { orientation: 'h', y: -0.15, x: 0.5, xanchor: 'center' }
            };

            // Format y-axis based on unit
            const unit = seriesList[0].unit.toLowerCase();
            if (unit.includes('percent')) {
                layout.yaxis.ticksuffix = '%';
                layout.yaxis.tickformat = '.1f';
            } else if (unit.includes('index')) {
                layout.yaxis.tickformat = ',.0f';
            } else if (unit.includes('thousands')) {
                layout.yaxis.tickformat = ',.0f';
            } else if (unit.includes('millions') || unit.includes('billions')) {
                layout.yaxis.tickformat = ',.0f';
            }

            Plotly.newPlot(container, traces, layout, {
                responsive: true,
                displayModeBar: true,
                modeBarButtonsToRemove: ['lasso2d', 'select2d', 'autoScale2d'],
                displaylogo: false
            });
        }

        function downloadCSV(seriesList, dataList, filename) {
            let csv = 'Date';
            for (const s of seriesList) {
                csv += ',"' + s.name + ' (' + s.id + ')"';
            }
            csv += '\n';

            // Build date-indexed data
            const allDates = new Set();
            const dataByDate = {};
            for (let i = 0; i < dataList.length; i++) {
                for (const d of dataList[i]) {
                    allDates.add(d.date);
                    if (!dataByDate[d.date]) dataByDate[d.date] = {};
                    dataByDate[d.date][i] = d.value;
                }
            }

            const sortedDates = Array.from(allDates).sort();
            for (const date of sortedDates) {
                csv += date;
                for (let i = 0; i < seriesList.length; i++) {
                    csv += ',' + (dataByDate[date]?.[i] ?? '');
                }
                csv += '\n';
            }

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        let isSearchResult = false;
        let aiExplanation = '';

        async function handleSearch() {
            const query = document.getElementById('query-input').value.trim();
            if (!query) return;

            currentQuery = query;
            isSearchResult = false;
            aiExplanation = '';
            document.getElementById('error').innerHTML = '';
            document.getElementById('results').innerHTML = '<div class="loading">Analyzing your question...</div>';

            try {
                // First, ask Claude to interpret the question like an economist
                const interpretation = await interpretQuery(query);

                if (interpretation && (interpretation.series?.length > 0 || interpretation.search_terms?.length > 0)) {
                    aiExplanation = interpretation.explanation || '';

                    // Try to get series from interpretation
                    let seriesList = [];

                    // First use any specific series IDs Claude recommended
                    if (interpretation.series && interpretation.series.length > 0) {
                        for (const id of interpretation.series) {
                            if (SERIES_DB[id]) {
                                seriesList.push({ id, ...SERIES_DB[id] });
                            } else {
                                // Fetch series info from FRED
                                const info = await fetchSeriesInfo(id);
                                if (info) seriesList.push(info);
                            }
                        }
                    }

                    // If still need more, search with provided terms
                    if (seriesList.length === 0 && interpretation.search_terms) {
                        document.getElementById('results').innerHTML = '<div class="loading">Searching FRED for relevant data...</div>';
                        for (const term of interpretation.search_terms) {
                            const searchResult = await searchFRED(term, 3);
                            if (searchResult && searchResult.series) {
                                seriesList.push(...searchResult.series);
                            }
                            if (seriesList.length >= 4) break;
                        }
                        isSearchResult = true;
                    }

                    if (seriesList.length > 0) {
                        currentSeries = seriesList.slice(0, 4);
                        await loadData(interpretation.combine_chart || false);
                        return;
                    }
                }

                // Fallback: try curated series
                let result = findSeries(query);
                if (!result) {
                    document.getElementById('results').innerHTML = '<div class="loading">Searching FRED database...</div>';
                    result = await searchFRED(query);
                    isSearchResult = true;
                }

                if (!result || result.series.length === 0) {
                    document.getElementById('error').innerHTML =
                        '<div class="error">No matching data found. Try rephrasing your question or browse <a href="https://fred.stlouisfed.org/" target="_blank">FRED directly</a>.</div>';
                    document.getElementById('results').innerHTML = '';
                    return;
                }

                currentSeries = result.series;
                await loadData(result.combine);

            } catch (e) {
                console.error('Search error:', e);
                document.getElementById('error').innerHTML = '<div class="error">Error: ' + e.message + '</div>';
                document.getElementById('results').innerHTML = '';
            }
        }

        async function interpretQuery(query) {
            try {
                const resp = await fetch('/api/interpret', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query })
                });
                if (!resp.ok) return null;
                return await resp.json();
            } catch (e) {
                console.error('Interpret error:', e);
                return null;
            }
        }

        async function fetchSeriesInfo(seriesId) {
            try {
                const resp = await fetch(`${BASE_URL}/series?series_id=${seriesId}`);
                const data = await resp.json();
                if (data.seriess && data.seriess.length > 0) {
                    const s = data.seriess[0];
                    return {
                        id: s.id,
                        name: s.title,
                        unit: s.units || '',
                        source: s.source || 'Federal Reserve Economic Data',
                        sa: s.seasonal_adjustment_short === 'SA',
                        frequency: s.frequency,
                        bullets: [
                            s.notes ? cleanNotes(s.notes) : `FRED series ${s.id}`,
                            `Source: ${s.source || 'FRED'}. ${s.seasonal_adjustment || ''}`
                        ]
                    };
                }
            } catch (e) {
                console.error('Fetch series info error:', e);
            }
            return null;
        }

        async function loadData(combine = false) {
            const results = document.getElementById('results');
            const years = document.getElementById('timeframe').value;

            try {
                const rawDataList = await Promise.all(
                    currentSeries.map(s => fetchData(s.id, years))
                );

                // Process data: apply YoY for price indices, create display series list
                const processedSeries = [];
                const processedData = [];

                for (let i = 0; i < currentSeries.length; i++) {
                    const series = { ...currentSeries[i] };
                    let data = rawDataList[i];

                    if (series.showYoY && data.length > 12) {
                        // For price indices, show YoY change (inflation rate) by default
                        const yoyData = calculateYoY(data);
                        processedSeries.push({
                            ...series,
                            name: series.yoyName || series.name + ' (YoY %)',
                            unit: series.yoyUnit || 'Percent Change (Year-over-Year)',
                            originalUnit: series.unit,
                            isYoY: true
                        });
                        processedData.push(yoyData);
                    } else if (series.canInflationAdjust && cpiData && Object.keys(cpiData).length > 0) {
                        // For wages/retail, show inflation-adjusted data
                        const realData = adjustForInflation(data);
                        processedSeries.push({
                            ...series,
                            name: 'Real ' + series.name + ' (2024 $)',
                            unit: series.unit.replace('Dollars', '2024 Dollars'),
                            isReal: true
                        });
                        processedData.push(realData);
                    } else {
                        processedSeries.push(series);
                        processedData.push(data);
                    }
                }

                // Store for download purposes (raw data) and update current for display
                currentData = processedData;
                const displaySeries = processedSeries;

                let html = generateNarrative(displaySeries, processedData, isSearchResult);

                if (combine && displaySeries.length > 1) {
                    // Single combined chart
                    const series = displaySeries;
                    const saNote = series.every(s => s.sa) ? 'Seasonally adjusted.' :
                                   series.some(s => s.sa) ? 'Some series seasonally adjusted.' : 'Not seasonally adjusted.';
                    const yoyNote = series.some(s => s.isYoY) ? ' Showing year-over-year percent change.' : '';
                    const realNote = series.some(s => s.isReal) ? ' Inflation-adjusted to 2024 dollars.' : '';

                    html += `
                        <div class="chart-section">
                            <div class="chart-header">
                                <div class="chart-title">${series.map(s => s.name).join(' vs. ')}</div>
                                <ul class="chart-bullets">
                                    ${series[0].bullets ? `<li>${series[0].bullets[0]}</li>` : ''}
                                    ${series[1]?.bullets ? `<li>${series[1].bullets[0]}</li>` : ''}
                                </ul>
                            </div>
                            <div class="chart-container">
                                <div class="chart" id="chart-combined"></div>
                            </div>
                            <div class="chart-actions">
                                <button class="download-btn" onclick="downloadCSV(currentSeries, currentData, '${series[0].id}_data.csv')">Download CSV</button>
                            </div>
                            <div class="source-line">
                                Source: ${series[0].source}. ${saNote}${yoyNote}${realNote} Shaded areas indicate U.S. recessions (NBER).
                            </div>
                        </div>
                    `;
                } else {
                    // Separate charts
                    for (let i = 0; i < displaySeries.length; i++) {
                        const series = displaySeries[i];
                        const data = processedData[i];
                        if (!data || data.length === 0) continue;

                        const saNote = series.sa ? 'Seasonally adjusted.' : 'Not seasonally adjusted.';
                        const yoyNote = series.isYoY ? ' Showing year-over-year percent change.' : '';
                        const realNote = series.isReal ? ' Inflation-adjusted to 2024 dollars.' : '';
                        const bullets = series.bullets || [
                            `FRED series: ${series.id}`,
                            `Unit: ${series.unit}`
                        ];

                        html += `
                            <div class="chart-section">
                                <div class="chart-header">
                                    <div class="chart-title">${series.name}</div>
                                    <ul class="chart-bullets">
                                        <li>${bullets[0]}</li>
                                        <li>${bullets[1]}</li>
                                    </ul>
                                </div>
                                <div class="chart-container">
                                    <div class="chart" id="chart-${i}"></div>
                                </div>
                                <div class="chart-actions">
                                    <button class="download-btn" onclick="downloadCSV([currentSeries[${i}]], [currentData[${i}]], '${series.id}_data.csv')">Download CSV</button>
                                </div>
                                <div class="source-line">
                                    Source: ${series.source}. ${saNote}${yoyNote}${realNote} Shaded areas indicate U.S. recessions (NBER).
                                </div>
                            </div>
                        `;
                    }
                }

                results.innerHTML = html;

                // Render charts
                setTimeout(() => {
                    if (combine && displaySeries.length > 1) {
                        const container = document.getElementById('chart-combined');
                        if (container) {
                            createChart(container, displaySeries, processedData, true);
                        }
                    } else {
                        for (let i = 0; i < displaySeries.length; i++) {
                            const container = document.getElementById(`chart-${i}`);
                            if (container && processedData[i]) {
                                createChart(container, [displaySeries[i]], [processedData[i]], false);
                            }
                        }
                    }
                }, 50);

            } catch (e) {
                results.innerHTML = `<div class="error">Failed to load data: ${e.message}</div>`;
            }
        }

        function search(query) {
            document.getElementById('query-input').value = query;
            handleSearch();
        }

        function refresh() {
            if (currentSeries.length > 0) {
                const result = findSeries(currentQuery);
                loadData(result?.combine || false);
            }
        }

        document.getElementById('query-input').addEventListener('keypress', e => {
            if (e.key === 'Enter') handleSearch();
        });
    </script>
</body>
</html>
